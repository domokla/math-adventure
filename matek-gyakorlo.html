<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Matek Kaland 0-20</title>
  <style>
    :root {
      --bg1: #fff7d6;
      --bg2: #dff7ff;
      --card: #ffffffee;
      --text: #243447;
      --accent: #ff8a5b;
      --ok: #1d9d54;
      --bad: #d83a3a;
      --shadow: 0 12px 30px rgba(36, 52, 71, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      font-family: "Trebuchet MS", "Comic Sans MS", Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 10% 20%, #fff5a0 0%, transparent 45%),
        radial-gradient(circle at 90% 80%, #b8ecff 0%, transparent 45%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding: 16px;
    }

    .app {
      width: min(720px, 100%);
      background: var(--card);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 18px;
      animation: popIn 0.5s ease;
    }

    h1 {
      margin: 0 0 8px;
      text-align: center;
      font-size: clamp(1.5rem, 4.8vw, 2.5rem);
    }

    .subtitle {
      text-align: center;
      margin: 0 0 18px;
      font-size: clamp(1rem, 2.8vw, 1.2rem);
    }

    .setup,
    .play,
    .result {
      display: none;
      animation: fadeUp 0.35s ease;
    }

    .show {
      display: block;
    }

    label,
    .meta {
      font-size: 1rem;
      font-weight: 700;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    input[type="number"] {
      width: 110px;
      border: 3px solid #cdd9e4;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 1.1rem;
      text-align: center;
      font-weight: 700;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #6bb9ff;
      box-shadow: 0 0 0 3px #cce9ff;
    }

    button {
      border: none;
      border-radius: 14px;
      padding: 11px 18px;
      font-size: 1rem;
      font-weight: 800;
      cursor: pointer;
      background: var(--accent);
      color: white;
      transition: transform 0.15s ease, filter 0.15s ease;
    }

    button:hover {
      filter: brightness(1.05);
    }

    button:active {
      transform: translateY(1px) scale(0.99);
    }

    .hud {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 14px;
    }

    .pill {
      background: #f0f7ff;
      border: 2px solid #d2e8ff;
      border-radius: 14px;
      padding: 10px;
      text-align: center;
      font-weight: 800;
      font-size: clamp(1rem, 3.1vw, 1.2rem);
    }

    .question {
      text-align: center;
      font-size: clamp(2rem, 10vw, 4rem);
      font-weight: 900;
      margin: 8px 0 14px;
      letter-spacing: 1px;
    }

    #answerInput {
      width: 170px;
      font-size: 1.6rem;
      border-width: 4px;
    }

    .feedback {
      text-align: center;
      min-height: 1.8em;
      font-size: 1.2rem;
      font-weight: 900;
      margin-top: 10px;
      transition: color 0.2s ease;
    }

    .ok {
      color: var(--ok);
    }

    .bad {
      color: var(--bad);
    }

    .card {
      background: #f8fbff;
      border: 2px solid #e0ecf8;
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      text-align: center;
    }

    .big-msg {
      font-size: clamp(1.2rem, 4.6vw, 2rem);
      font-weight: 900;
      margin: 8px 0;
    }

    .reward-image {
      width: min(100%, 460px);
      border-radius: 16px;
      border: 4px solid white;
      box-shadow: var(--shadow);
      margin-top: 10px;
    }

    .small {
      font-size: 0.95rem;
      opacity: 0.85;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.96);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>Matek Kaland No√©minek</h1>
    <p class="subtitle">√ñsszead√°s √©s kivon√°s a 0‚Äì20-as sz√°mk√∂rben</p>

    <section id="setup" class="setup show">
      <div class="row">
        <label for="taskCount">H√°ny feladat legyen?</label>
        <input id="taskCount" type="number" min="1" max="100" step="1" value="10" />
        <button id="startBtn">Start</button>
      </div>
      <p class="small" style="text-align:center; margin-top:10px;">Tipp: 5 / 10 / 20 j√≥ kezd√©s.</p>
    </section>

    <section id="play" class="play">
      <div class="hud">
        <div class="pill">Feladat: <span id="progressText">0 / 0</span></div>
        <div class="pill">Eltelt id≈ë: <span id="timerText">0</span> mp</div>
      </div>

      <div id="questionText" class="question">0 + 0 = ?</div>

      <form id="answerForm" class="row">
        <input id="answerInput" type="number" inputmode="numeric" autocomplete="off" required />
        <button type="submit">V√°lasz</button>
      </form>
      <div id="feedbackText" class="feedback"></div>
    </section>

    <section id="result" class="result">
      <div class="card">
        <h2>Eredm√©nyed</h2>
        <p><strong>Helyes v√°laszok:</strong> <span id="correctOut">0</span></p>
        <p><strong>Sz√°zal√©k:</strong> <span id="percentOut">0</span>%</p>
        <p><strong>Id≈ëd:</strong> <span id="timeOut">0</span> m√°sodperc</p>
        <div id="rewardBox"></div>
        <button id="restartBtn" style="margin-top:12px;">√öjraind√≠t√°s</button>
      </div>
    </section>
  </main>

  <script>
    // Alap √°llapotv√°ltoz√≥k
    const state = {
      tasks: [],
      total: 0,
      index: 0,
      correct: 0,
      timerId: null,
      startTime: 0,
      elapsedSeconds: 0
    };

    // DOM elemek
    const setupSection = document.getElementById("setup");
    const playSection = document.getElementById("play");
    const resultSection = document.getElementById("result");
    const taskCountInput = document.getElementById("taskCount");
    const startBtn = document.getElementById("startBtn");
    const progressText = document.getElementById("progressText");
    const timerText = document.getElementById("timerText");
    const questionText = document.getElementById("questionText");
    const answerForm = document.getElementById("answerForm");
    const answerInput = document.getElementById("answerInput");
    const feedbackText = document.getElementById("feedbackText");
    const correctOut = document.getElementById("correctOut");
    const percentOut = document.getElementById("percentOut");
    const timeOut = document.getElementById("timeOut");
    const rewardBox = document.getElementById("rewardBox");
    const restartBtn = document.getElementById("restartBtn");

    // Automatikus k√©pkeres√©s helyi mapp√°b√≥l: images/pic-1.jpg, pic-2.png, ...
    // B√∂ng√©sz≈ëb≈ël k√∂zvetlen√ºl nem lehet mappalist√°t olvasni, ez√©rt mint√°ra pr√≥b√°ljuk a f√°jlokat.
    const rewardPool = {
      urls: [],
      scanned: false,
      scanning: false
    };

    startBtn.addEventListener("click", startPractice);
    answerForm.addEventListener("submit", handleSubmit);
    restartBtn.addEventListener("click", resetToSetup);

    function startPractice() {
      const total = Number(taskCountInput.value);
      if (!Number.isInteger(total) || total <= 0) {
        alert("Adj meg egy pozit√≠v eg√©sz sz√°mot!");
        return;
      }

      state.total = total;
      state.tasks = Array.from({ length: total }, generateTask);
      state.index = 0;
      state.correct = 0;
      state.elapsedSeconds = 0;
      scanRewardImages(true);

      showSection("play");
      renderTask();
      startTimer();
    }

    function generateTask() {
      const isAdd = Math.random() < 0.5;
      if (isAdd) {
        const a = randInt(0, 20);
        const b = randInt(0, 20 - a);
        return { a, b, op: "+", answer: a + b };
      }

      const a = randInt(0, 20);
      const b = randInt(0, a);
      return { a, b, op: "‚àí", answer: a - b };
    }

    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function renderTask() {
      const current = state.tasks[state.index];
      progressText.textContent = `${state.index + 1} / ${state.total}`;
      questionText.textContent = `${current.a} ${current.op} ${current.b} = ?`;
      feedbackText.textContent = "";
      feedbackText.className = "feedback";
      answerInput.value = "";
      answerInput.focus();
    }

    function handleSubmit(event) {
      event.preventDefault();
      const value = Number(answerInput.value);
      if (answerInput.value.trim() === "" || !Number.isFinite(value)) {
        feedbackText.textContent = "K√©rlek, √≠rj be egy sz√°mot!";
        feedbackText.className = "feedback bad";
        answerInput.focus();
        return;
      }

      const current = state.tasks[state.index];
      const isCorrect = value === current.answer;

      if (isCorrect) {
        state.correct += 1;
        feedbackText.textContent = "Helyes! √úgyes vagy!";
        feedbackText.className = "feedback ok";
        playSuccessSound();
      } else {
        feedbackText.textContent = `Nem j√≥. A helyes v√°lasz: ${current.answer}`;
        feedbackText.className = "feedback bad";
      }

      state.index += 1;
      if (state.index >= state.total) {
        setTimeout(finishPractice, 850);
      } else {
        setTimeout(renderTask, 850);
      }
    }

    function startTimer() {
      stopTimer();
      state.startTime = Date.now();
      state.timerId = setInterval(() => {
        const elapsed = (Date.now() - state.startTime) / 1000;
        state.elapsedSeconds = elapsed;
        timerText.textContent = Math.floor(elapsed).toString();
      }, 100);
    }

    function stopTimer() {
      if (state.timerId) {
        clearInterval(state.timerId);
        state.timerId = null;
      }
    }

    function finishPractice() {
      stopTimer();
      const percent = (state.correct / state.total) * 100;
      const roundedPercent = Math.round(percent * 10) / 10;
      const finalSeconds = Math.round(state.elapsedSeconds);

      correctOut.textContent = state.correct.toString();
      percentOut.textContent = roundedPercent.toString();
      timeOut.textContent = finalSeconds.toString();

      if (percent >= 95) {
        const animal = Math.random() < 0.5 ? "dolphin" : "penguin";
        const imageUrl = getRandomRewardImageUrl();

        rewardBox.innerHTML = `
          <p class="big-msg">Szuper vagy! Fantasztikus teljes√≠tm√©ny!</p>
          <img id="rewardImage" class="reward-image" src="${imageUrl || ""}" alt="Jutalom k√©p: ${animal}" />
          <p class="small">Ma nagyon √ºgyesen sz√°molt√°l!</p>
        `;
        attachRewardFallback(animal);
      } else {
        rewardBox.innerHTML = `
          <p class="big-msg">√úgyes volt√°l, pr√≥b√°ld √∫jra!</p>
          <p class="small">Minden gyakorl√°ssal egyre jobb leszel.</p>
        `;
      }

      showSection("result");
    }

    function resetToSetup() {
      stopTimer();
      timerText.textContent = "0";
      showSection("setup");
    }

    function showSection(name) {
      setupSection.classList.remove("show");
      playSection.classList.remove("show");
      resultSection.classList.remove("show");

      if (name === "setup") setupSection.classList.add("show");
      if (name === "play") playSection.classList.add("show");
      if (name === "result") resultSection.classList.add("show");
    }

    async function scanRewardImages(force = false) {
      if (rewardPool.scanning) return;
      if (rewardPool.scanned && !force) return;

      rewardPool.scanning = true;
      if (force) rewardPool.urls = [];

      const exts = ["jpg", "jpeg", "png", "webp", "gif"];
      const found = [];
      let missStreak = 0;
      const maxIndex = 300;

      for (let i = 1; i <= maxIndex && missStreak < 40; i += 1) {
        let foundForIndex = false;
        for (const ext of exts) {
          const url = `images/pic-${i}.${ext}`;
          const ok = await canLoadImage(url);
          if (ok) {
            found.push(url);
            foundForIndex = true;
          }
        }
        missStreak = foundForIndex ? 0 : missStreak + 1;
      }

      rewardPool.urls = found;
      rewardPool.scanned = true;
      rewardPool.scanning = false;
    }

    function canLoadImage(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
      });
    }

    function getRandomRewardImageUrl() {
      if (rewardPool.urls.length === 0) return "";
      return rewardPool.urls[randInt(0, rewardPool.urls.length - 1)];
    }

    function attachRewardFallback(animal) {
      const rewardImage = document.getElementById("rewardImage");
      if (!rewardImage) return;

      rewardImage.onerror = () => {
        rewardImage.onerror = null;
        rewardImage.src = createFallbackRewardDataUri(animal);
      };
    }

    function createFallbackRewardDataUri(animal) {
      const isDolphin = animal === "dolphin";
      const title = isDolphin ? "Delfin jutalom" : "Pingvin jutalom";
      const icon = isDolphin ? "üê¨" : "üêß";
      const colorA = isDolphin ? "#9de7ff" : "#cde5ff";
      const colorB = isDolphin ? "#d6fbff" : "#eef6ff";
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="900" height="550" viewBox="0 0 900 550" role="img" aria-label="${title}">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="${colorA}" />
              <stop offset="100%" stop-color="${colorB}" />
            </linearGradient>
          </defs>
          <rect width="900" height="550" rx="30" fill="url(#g)" />
          <circle cx="130" cy="95" r="34" fill="#fff" opacity="0.45" />
          <circle cx="800" cy="120" r="24" fill="#fff" opacity="0.38" />
          <text x="450" y="245" text-anchor="middle" font-size="140">` + icon + `</text>
          <text x="450" y="345" text-anchor="middle" font-size="52" font-family="Trebuchet MS, Arial, sans-serif" fill="#16406a">Szuper vagy!</text>
        </svg>
      `;
      return "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(svg);
    }

    // Els≈ë bet√∂lt√©skor megpr√≥b√°ljuk fel√©p√≠teni a k√©plist√°t.
    scanRewardImages();

    // Egyszer≈±, r√∂vid "siker" hang k√ºls≈ë f√°jl n√©lk√ºl
    function playSuccessSound() {
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.setValueAtTime(660, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.11);
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.14);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.14);
      } catch (_) {
        // Ha a b√∂ng√©sz≈ë tiltja a hangot, akkor csendben tov√°bbmegy√ºnk.
      }
    }
  </script>
</body>
</html>
